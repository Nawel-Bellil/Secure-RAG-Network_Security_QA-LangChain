name: CI Pipeline 

on:
  push:
    branches: [ main, dev, develop ]
  pull_request:
    branches: [ main, dev ]

jobs:
  # ============================================
  # JOB 1: Quick Validation
  # ============================================
  validate:
    name: Quick Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Check Required Files
        run: |
          echo "ðŸ“ Checking required files..."
          files="app.py docker-compose.yml Dockerfile requirements.txt"
          for file in $files; do
            if [ -f "$file" ]; then
              echo "âœ… $file exists"
            else
              echo "âŒ $file missing"
            fi
          done

  # ============================================
  # JOB 2: Security Scanning (Non-blocking)
  # ============================================
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Security Tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety || echo "Failed to install some tools"
      
      - name: Run Bandit
        run: |
          bandit -r . -f txt || true
        continue-on-error: true
      
      - name: Check Dependencies
        run: |
          pip install -r requirements.txt
          safety check || true
        continue-on-error: true

  # ============================================
  # JOB 3: Code Quality (Non-blocking)
  # ============================================
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Linting Tools
        run: |
          pip install flake8 || echo "Flake8 install failed"
      
      - name: Run Flake8
        run: |
          flake8 app.py --max-line-length=120 --extend-ignore=E203,W503 || true
        continue-on-error: true

  # ============================================
  # JOB 4: Docker Validation
  # ============================================
  docker-check:
    name: Docker Configuration Check
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Validate Docker Compose
        run: |
          docker compose config --quiet || echo "Docker compose validation failed"
        continue-on-error: true
      
      - name: Validate Nginx Config
        run: |
          if [ -f nginx.conf ]; then
            docker run --rm -v $(pwd)/nginx.conf:/etc/nginx/nginx.conf:ro nginx:alpine nginx -t || true
          fi
        continue-on-error: true

  # ============================================
  # JOB 5: Build Report
  # ============================================
  report:
    name: Build Report
    runs-on: ubuntu-latest
    needs: [validate, security-scan, code-quality, docker-check]
    if: always()
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ CI Pipeline Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All jobs completed" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
